<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orçamento do Casamento - Gabriel & Leliane</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rose: {
                            50: '#fdf2f8',
                            100: '#fce7f3',
                            200: '#fbcfe8',
                            300: '#f9a8d4',
                            400: '#f472b6',
                            500: '#ec4899',
                            600: '#db2777',
                            700: '#be185d',
                            800: '#9d174d',
                            900: '#831843'
                        },
                        gold: {
                            50: '#fffdf7',
                            100: '#fffbeb',
                            200: '#fef3c7',
                            300: '#fde68a',
                            400: '#fcd34d',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;600;700&family=Poppins:wght@300;400;500;600;700&display=swap');
        
        .font-dancing {
            font-family: 'Dancing Script', cursive;
        }
        
        .font-poppins {
            font-family: 'Poppins', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 25%, #fbcfe8 50%, #f9a8d4 75%, #f472b6 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="font-poppins gradient-bg min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-rose-400 via-rose-500 to-gold-400 text-white py-4 sm:py-6 shadow-lg">
        <div class="container mx-auto px-2 sm:px-4">
            <div class="text-center">
                <h1 class="font-dancing text-2xl sm:text-3xl md:text-4xl font-bold">Orçamento do Casamento</h1>
                <p class="text-rose-100 text-xs sm:text-sm md:text-base">Gabriel & Leliane - Gerencie seus gastos de forma inteligente</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <div class="text-center mb-6 sm:mb-8">
            <h2 class="font-dancing text-2xl sm:text-3xl md:text-4xl text-rose-700 font-bold mb-2 sm:mb-4">Planejamento de Orçamento</h2>
            <p class="text-gray-600 text-sm sm:text-base md:text-lg px-2">Gerencie suas finanças para o casamento dos sonhos</p>
        </div>

        <!-- Budget Calculator -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 mb-6 sm:mb-8">
            <div class="bg-white/90 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-6 card-hover">
                <h3 class="text-lg sm:text-xl md:text-2xl font-semibold text-rose-600 mb-4 flex items-center">
                    <i class="fas fa-calculator mr-2 sm:mr-3 text-sm sm:text-base"></i>
                    Calculadora de Orçamento
                </h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2 text-sm sm:text-base">Orçamento Total (R$)</label>
                        <input type="number" id="total-budget" placeholder="50000" class="w-full px-3 sm:px-4 py-2 border border-rose-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 text-sm sm:text-base" oninput="calculateBudget()">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 sm:gap-4 text-center">
                        <div class="bg-rose-50 p-3 sm:p-4 rounded-lg">
                            <div class="text-lg sm:text-xl md:text-2xl font-bold text-rose-600" id="total-spent">R$ 0</div>
                            <div class="text-xs sm:text-sm text-gray-600">Total Gasto</div>
                        </div>
                        <div class="bg-green-50 p-3 sm:p-4 rounded-lg">
                            <div class="text-lg sm:text-xl md:text-2xl font-bold text-green-600" id="remaining-budget">R$ 0</div>
                            <div class="text-xs sm:text-sm text-gray-600">Restante</div>
                        </div>
                    </div>
                    
                    <div class="w-full bg-gray-200 rounded-full h-3 sm:h-4">
                        <div id="budget-progress" class="progress-bar bg-gradient-to-r from-green-400 to-rose-500 h-3 sm:h-4 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="text-center text-xs sm:text-sm text-gray-600">
                        <span id="budget-percentage">0%</span> do orçamento utilizado
                    </div>
                </div>
            </div>
            
            <div class="bg-white/90 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-6 card-hover">
                <h3 class="text-lg sm:text-xl md:text-2xl font-semibold text-gold-600 mb-4 flex items-center">
                    <i class="fas fa-chart-pie mr-2 sm:mr-3 text-sm sm:text-base"></i>
                    Distribuição por Categoria
                </h3>
                
                <div class="space-y-3">
                    <div class="flex justify-between items-center text-xs sm:text-sm">
                        <span class="text-gray-700">Local & Decoração</span>
                        <span class="font-semibold text-rose-600">35%</span>
                    </div>
                    <div class="flex justify-between items-center text-xs sm:text-sm">
                        <span class="text-gray-700">Comida & Bebida</span>
                        <span class="font-semibold text-gold-600">30%</span>
                    </div>
                    <div class="flex justify-between items-center text-xs sm:text-sm">
                        <span class="text-gray-700">Fotografia & Vídeo</span>
                        <span class="font-semibold text-green-600">15%</span>
                    </div>
                    <div class="flex justify-between items-center text-xs sm:text-sm">
                        <span class="text-gray-700">Música & Entretenimento</span>
                        <span class="font-semibold text-blue-600">8%</span>
                    </div>
                    <div class="flex justify-between items-center text-xs sm:text-sm">
                        <span class="text-gray-700">Vestimentas & Beleza</span>
                        <span class="font-semibold text-purple-600">7%</span>
                    </div>
                    <div class="flex justify-between items-center text-xs sm:text-sm">
                        <span class="text-gray-700">Outros & Imprevistos</span>
                        <span class="font-semibold text-gray-600">5%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Categories -->
        <div class="bg-white/90 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl p-4 sm:p-6 mb-6 sm:mb-8 card-hover">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 sm:mb-6 space-y-2 sm:space-y-0">
                <h3 class="text-lg sm:text-xl md:text-2xl font-semibold text-rose-600 flex items-center">
                    <i class="fas fa-list-ul mr-2 sm:mr-3 text-sm sm:text-base"></i>
                    Categorias de Gastos
                </h3>
                <button onclick="addBudgetItem()" class="px-3 sm:px-4 py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600 transition text-sm sm:text-base shrink-0">
                    <i class="fas fa-plus mr-1 sm:mr-2"></i>Adicionar Item
                </button>
            </div>
            
            <div class="grid gap-3 sm:gap-4" id="budget-categories">
                <!-- Budget categories will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-rose-600 text-white py-6 sm:py-8 mt-8 sm:mt-12">
        <div class="container mx-auto px-2 sm:px-4 text-center">
            <div class="mb-3 sm:mb-4">
                <i class="fas fa-heart text-lg sm:text-xl md:text-2xl text-rose-300 mb-2"></i>
                <h3 class="font-dancing text-xl sm:text-2xl md:text-3xl font-bold">Gabriel & Leliane</h3>
            </div>
            <p class="text-rose-200 text-sm sm:text-base px-2">Planejando nosso casamento dos sonhos</p>
            <div class="mt-3 sm:mt-4 text-rose-300">
                <p class="text-xs sm:text-sm">&copy; 2025 - Feito com amor</p>
            </div>
        </div>
    </footer>

    <script>
        // API Configuration
        const API_BASE_URL = window.location.origin + '/api';
        const USE_LOCAL_STORAGE = false; // Backend is ready
        
        // Simplified data structure for budget only
        let weddingData = {
            id: null,
            totalBudget: 0,
            budgetItems: [
                { id: 1, category: "Local & Decoração", amount: 0, percentage: 35, completed: false, estimatedCost: 0, actualCost: 0, notes: '' },
                { id: 2, category: "Comida & Bebida", amount: 0, percentage: 30, completed: false, estimatedCost: 0, actualCost: 0, notes: '' },
                { id: 3, category: "Fotografia & Vídeo", amount: 0, percentage: 15, completed: false, estimatedCost: 0, actualCost: 0, notes: '' },
                { id: 4, category: "Música & Entretenimento", amount: 0, percentage: 8, completed: false, estimatedCost: 0, actualCost: 0, notes: '' },
                { id: 5, category: "Vestimentas & Beleza", amount: 0, percentage: 7, completed: false, estimatedCost: 0, actualCost: 0, notes: '' },
                { id: 6, category: "Outros & Imprevistos", amount: 0, percentage: 5, completed: false, estimatedCost: 0, actualCost: 0, notes: '' }
            ]
        };

        // API Helper Functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            if (USE_LOCAL_STORAGE) {
                return null;
            }
            
            try {
                const config = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    config.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showError('Erro de conexão com o servidor. Verifique sua internet.');
                return null;
            }
        }
        
        // Backend API Methods
        const WeddingAPI = {
            async createWedding(weddingData) {
                return await apiCall('/wedding', 'POST', weddingData);
            },
            
            async getWedding(id) {
                return await apiCall(`/wedding/${id}`, 'GET');
            },
            
            async updateWedding(id, data) {
                return await apiCall(`/wedding/${id}`, 'PUT', data);
            },
            
            async createBudgetItem(weddingId, budgetData) {
                return await apiCall(`/wedding/${weddingId}/budget`, 'POST', budgetData);
            },
            
            async updateBudgetItem(itemId, data) {
                return await apiCall(`/budget/${itemId}`, 'PUT', data);
            },
            
            async deleteBudgetItem(itemId) {
                return await apiCall(`/budget/${itemId}`, 'DELETE');
            }
        };
        
        // Error Display Function
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            errorDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // Success Display Function
        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            successDiv.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // Load data from localStorage or API
        async function loadData() {
            if (USE_LOCAL_STORAGE) {
                const saved = localStorage.getItem('weddingBudgetData');
                if (saved) {
                    weddingData = { ...weddingData, ...JSON.parse(saved) };
                }
                return;
            }
            
            // Try to load from API
            const weddingId = localStorage.getItem('currentWeddingId');
            
            if (weddingId) {
                const apiData = await WeddingAPI.getWedding(weddingId);
                if (apiData) {
                    weddingData = { 
                        id: apiData.id,
                        totalBudget: apiData.totalBudget,
                        budgetItems: apiData.budgetItems || weddingData.budgetItems
                    };
                }
            }
        }

        // Save data to localStorage and API
        async function saveData() {            
            if (USE_LOCAL_STORAGE) {
                localStorage.setItem('weddingBudgetData', JSON.stringify(weddingData));
                return;
            }
            
            // Save to API
            if (weddingData.id) {
                await WeddingAPI.updateWedding(weddingData.id, {
                    totalBudget: weddingData.totalBudget
                });
            } else {
                const newWedding = await WeddingAPI.createWedding({
                    totalBudget: weddingData.totalBudget,
                    coupleInfo: {
                        bride: { name: 'Leliane' },
                        groom: { name: 'Gabriel' }
                    }
                });
                if (newWedding) {
                    weddingData.id = newWedding.id;
                    localStorage.setItem('currentWeddingId', newWedding.id);
                    
                    // Load the complete data from backend
                    const completeData = await WeddingAPI.getWedding(newWedding.id);
                    if (completeData) {
                        weddingData.budgetItems = completeData.budgetItems || weddingData.budgetItems;
                        showSuccess('Orçamento criado com sucesso!');
                    }
                }
            }
        }

        // Initialize wedding plan if needed
        async function initializeWedding() {
            if (!weddingData.id && !USE_LOCAL_STORAGE) {
                await saveData();
            }
        }

        // Render budget items
        function renderBudgetItems() {
            const container = document.getElementById('budget-categories');
            container.innerHTML = '';
            
            weddingData.budgetItems.forEach(item => {
                const budgetAmount = (weddingData.totalBudget * item.percentage / 100);
                const itemElement = document.createElement('div');
                itemElement.className = 'p-4 bg-gradient-to-r from-rose-50 to-gold-50 rounded-lg border border-rose-200';
                itemElement.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" ${item.completed ? 'checked' : ''} 
                                   onchange="toggleBudgetItem(${item.id})"
                                   class="w-5 h-5 text-rose-600 rounded focus:ring-rose-500">
                            <span class="font-semibold text-gray-800">${item.category}</span>
                            <span class="text-sm text-gray-600">(${item.percentage}%)</span>
                        </div>
                        <button onclick="removeBudgetItem(${item.id})" 
                                class="text-red-500 hover:text-red-700 transition p-1">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-xs text-gray-600">Valor Alocado</label>
                            <div class="text-lg font-bold text-green-600">R$ ${budgetAmount.toLocaleString('pt-BR')}</div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-600">Valor Gasto</label>
                            <input type="number" value="${item.amount}" 
                                   onchange="updateBudgetItemAmount(${item.id}, this.value)"
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-rose-600 font-semibold">
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-green-400 to-rose-500 h-2 rounded-full" 
                                 style="width: ${Math.min((item.amount / budgetAmount) * 100, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            ${((item.amount / budgetAmount) * 100).toFixed(1)}% utilizado
                        </div>
                    </div>
                `;
                container.appendChild(itemElement);
            });
            
            calculateBudget();
        }

        // Calculate budget totals
        function calculateBudget() {
            const totalBudgetInput = document.getElementById('total-budget');
            const totalBudget = parseFloat(totalBudgetInput.value) || 0;
            
            weddingData.totalBudget = totalBudget;
            
            const totalSpent = weddingData.budgetItems.reduce((sum, item) => sum + (item.amount || 0), 0);
            const remaining = totalBudget - totalSpent;
            const percentage = totalBudget > 0 ? (totalSpent / totalBudget) * 100 : 0;
            
            document.getElementById('total-spent').textContent = `R$ ${totalSpent.toLocaleString('pt-BR')}`;
            document.getElementById('remaining-budget').textContent = `R$ ${remaining.toLocaleString('pt-BR')}`;
            document.getElementById('budget-percentage').textContent = `${percentage.toFixed(1)}%`;
            document.getElementById('budget-progress').style.width = `${Math.min(percentage, 100)}%`;
            
            // Update remaining budget color
            const remainingEl = document.getElementById('remaining-budget');
            if (remaining < 0) {
                remainingEl.className = remainingEl.className.replace('text-green-600', 'text-red-600');
            } else {
                remainingEl.className = remainingEl.className.replace('text-red-600', 'text-green-600');
            }
            
            saveData();
            renderBudgetItems();
        }

        // Toggle budget item completion
        async function toggleBudgetItem(itemId) {
            const item = weddingData.budgetItems.find(i => i.id === itemId);
            if (item) {
                item.completed = !item.completed;
                
                if (!USE_LOCAL_STORAGE && weddingData.id) {
                    await WeddingAPI.updateBudgetItem(itemId, { completed: item.completed });
                }
                
                await saveData();
                renderBudgetItems();
            }
        }

        // Update budget item amount
        async function updateBudgetItemAmount(itemId, newAmount) {
            const item = weddingData.budgetItems.find(i => i.id === itemId);
            if (item) {
                item.amount = parseFloat(newAmount) || 0;
                
                if (!USE_LOCAL_STORAGE && weddingData.id) {
                    await WeddingAPI.updateBudgetItem(itemId, { amount: item.amount });
                }
                
                await saveData();
                calculateBudget();
            }
        }

        // Add new budget item
        async function addBudgetItem() {
            const category = prompt('Nome da categoria:');
            const percentage = parseFloat(prompt('Porcentagem do orçamento (0-100):'));
            
            if (category && !isNaN(percentage) && percentage > 0 && percentage <= 100) {
                const newId = Math.max(...weddingData.budgetItems.map(item => item.id), 0) + 1;
                
                const newBudgetItem = {
                    id: newId,
                    category: category,
                    amount: 0,
                    percentage: percentage,
                    completed: false,
                    estimatedCost: 0,
                    actualCost: 0,
                    notes: ''
                };
                
                weddingData.budgetItems.push(newBudgetItem);
                
                if (!USE_LOCAL_STORAGE && weddingData.id) {
                    const apiBudgetItem = await WeddingAPI.createBudgetItem(weddingData.id, newBudgetItem);
                    if (apiBudgetItem) {
                        weddingData.budgetItems[weddingData.budgetItems.length - 1].id = apiBudgetItem.id;
                        showSuccess('Item de orçamento adicionado!');
                    }
                }
                
                await saveData();
                renderBudgetItems();
            }
        }

        // Remove budget item
        async function removeBudgetItem(itemId) {
            if (!USE_LOCAL_STORAGE && weddingData.id) {
                const success = await WeddingAPI.deleteBudgetItem(itemId);
                if (!success) {
                    showError('Erro ao remover item do servidor');
                    return;
                }
            }
            
            weddingData.budgetItems = weddingData.budgetItems.filter(i => i.id !== itemId);
            await saveData();
            renderBudgetItems();
            showSuccess('Item removido com sucesso!');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            await loadData();
            await initializeWedding();
            
            renderBudgetItems();
            calculateBudget();
            
            // Set total budget if saved
            if (weddingData.totalBudget > 0) {
                document.getElementById('total-budget').value = weddingData.totalBudget;
            }
        });
    </script>
</body>
</html>